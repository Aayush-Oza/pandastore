<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panda Store ‚Äì Product Details</title>

  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="stylesheet" href="../assets/css/product_detail.css">

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    .slider {
      position: relative;
      width: 100%;
      max-width: 420px;
    }

    .slider img {
      width: 100%;
      border-radius: 14px;
      object-fit: cover;
    }

    .slider-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0,0,0,.6);
      color: white;
      border: none;
      font-size: 18px;
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 50%;
    }

    .prev { left: 8px; }
    .next { right: 8px; }

    .dots {
      display: flex;
      gap: 6px;
      justify-content: center;
      margin-top: 10px;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ccc;
      cursor: pointer;
    }

    .dot.active {
      background: var(--red);
    }
  </style>
</head>

<body>

<header class="header">
  <div class="container header-inner">
    <div class="brand">
      <span class="brand-icon">üêº</span>
      <span class="brand-text">Panda<span>Store</span></span>
    </div>
    <div class="hamburger" onclick="toggleNav()">
            <span></span><span></span><span></span>
        </div>
    <nav class="nav">
      <ul class="nav-list">
        <li><a href="/pandastore/index.html">Products</a></li>
        <li><a href="/pandastore/templates/cart.html">Cart</a></li>
        <li><a href="/pandastore/templates/orders.html">Orders</a></li>
        <li><a href="/pandastore/templates/profile.html">Profile</a></li>
        <li id="logoutLink" style="display:none;">
    <a href="#" onclick="logoutUser()">Logout</a>
  </li>
      </ul>
    </nav>
  </div>
</header>

<main class="container product-page">
  <div id="productBox"></div>
  <section class="suggestions">
  <h3>You may also like</h3>
  <div id="suggestionGrid" class="suggestion-grid"></div>
</section>
</main>

<div id="toast" class="toast"></div>

<script src="../assets/js/app.js"></script>

<script>
let currentIndex = 0;
let images = [];

document.addEventListener("DOMContentLoaded", loadProductDetails);

async function loadProductDetails() {
  const id = new URLSearchParams(window.location.search).get("id");
  if (!id) location.href = "/pandastore/index.html";

  const res = await fetch(`${CONFIG.API}/products`);
  const products = await res.json();
  const product = products.find(p => p.id == id);

  if (!product) {
    showToast("Product not found", "error");
    return;
  }
  currentIndex = 0;   
  images = product.images || [];

  document.getElementById("productBox").innerHTML = `
    <div class="product-detail-card">

      <div class="product-image">
        ${renderImages()}
      </div>

      <div class="product-content">
        <span class="category">${product.category || "General"}</span>
        <h1 class="title">${product.name}</h1>

        <div class="price-row">
          <span class="price">‚Çπ${product.price}</span>
          <span class="stock ${product.stock > 0 ? "in" : "out"}">
            ${product.stock > 0 ? `In stock (${product.stock})` : "Out of stock"}
          </span>
        </div>

        ${product.description ? `<p class="description">${product.description}</p>` : ""}

        <div class="buy-box">
          <input id="qty" type="number" min="1" value="1">
          <button ${product.stock <= 0 ? "disabled" : ""} onclick="addToCart(${product.id})">
            ${product.stock > 0 ? "Add to Cart" : "Unavailable"}
          </button>
        </div>
      </div>

    </div>
  `;
  renderSuggestions(product, products);
}

/* IMAGE RENDER */
function renderImages() {
  if (!images.length) {
    return `<img src="../assets/img/no-image.png">`;
  }

  if (images.length === 1) {
    return `<img src="${images[0].url}">`;
  }

  return `
    <div class="slider">
      <img src="${images[0].url}" id="sliderImg">
      <button class="slider-btn prev" onclick="changeSlide(-1)">‚Äπ</button>
      <button class="slider-btn next" onclick="changeSlide(1)">‚Ä∫</button>
    </div>
    <div class="dots">
      ${images.map((_, i) =>
        `<div class="dot ${i === 0 ? "active" : ""}" onclick="goToSlide(${i})"></div>`
      ).join("")}
    </div>
  `;
}

/* SLIDER LOGIC */
function changeSlide(dir) {
  currentIndex = (currentIndex + dir + images.length) % images.length;
  updateSlide();
}

function goToSlide(i) {
  currentIndex = i;
  updateSlide();
}

function updateSlide() {
  document.getElementById("sliderImg").src = images[currentIndex].url;
  document.querySelectorAll(".dot").forEach((d, i) =>
    d.classList.toggle("active", i === currentIndex)
  );
}
function renderSuggestions(current, allProducts) {
  const grid = document.getElementById("suggestionGrid");
  if (!grid) return;

  let suggestions = allProducts.filter(
    p => p.id !== current.id && p.category === current.category
  );

  if (suggestions.length < 4) {
    const others = allProducts.filter(
      p => p.id !== current.id && p.category !== current.category
    );
    suggestions = suggestions.concat(others);
  }

  suggestions = suggestions.slice(0, 10);

  grid.innerHTML = suggestions.map(p => `
    <div class="suggestion-card" onclick="openProduct(${p.id})">
      <img src="${p.images?.[0]?.url || '../assets/img/no-image.png'}">
      <h4>${p.name}</h4>
      <span>‚Çπ${p.price}</span>
    </div>
  `).join("");
}

</script>

</body>
</html>
