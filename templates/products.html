<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Manage Products – Admin</title>

<link rel="stylesheet" href="../assets/css/style.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>

<style>
body {
  background:#f5f5f5;
  font-family:Poppins,sans-serif;
}

/* ================= PRODUCT CARD ================= */
.product-card {
  background:#fff;
  padding:16px;
  border-radius:14px;
  box-shadow:0 6px 18px rgba(0,0,0,.08);
  display:flex;
  gap:16px;
  align-items:flex-start;
  margin-bottom:16px;
  flex-wrap:wrap;
}

.image-row {
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}

.img-wrap {
  position:relative;
}

.img-wrap img {
  width:90px;
  height:90px;
  object-fit:cover;
  border-radius:10px;
}

.img-wrap button {
  position:absolute;
  top:6px;
  right:6px;
  width:22px;
  height:22px;
  border:none;
  border-radius:50%;
  background:rgba(0,0,0,0.75);
  color:#fff;
  font-size:13px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  transition:background .2s, transform .15s;
}

.img-wrap button:hover {
  background:#e63946;
  transform:scale(1.1);
}

.add-img-btn {
  background:#2ecc71;
  border:none;
  color:#fff;
  padding:6px 10px;
  border-radius:8px;
  cursor:pointer;
  height:fit-content;
}

/* ================= ACTIONS ================= */
.product-actions {
  display:flex;
  gap:8px;
  margin-left:auto;
}

/* ================= MODAL ================= */
.modal {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

.modal-box {
  background:#fff;
  width:100%;
  max-width:420px;
  padding:22px;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
  animation:pop .25s ease;
}

.modal-box h3 {
  margin-bottom:12px;
}

.modal-box input {
  width:100%;
  padding:10px;
  margin-bottom:12px;
  border-radius:8px;
  border:1px solid #ccc;
}

/* ================= MOBILE ================= */
@media(max-width:600px){
  .product-card {
    flex-direction:column;
  }
  .product-actions {
    width:100%;
    justify-content:space-between;
    margin-left:0;
  }
}

@keyframes pop {
  from { transform:scale(.9); opacity:0; }
  to { transform:scale(1); opacity:1; }
}
</style>
</head>

<body>

<script>
if (localStorage.getItem("is_admin") !== "true") {
  location.href = "admin-login.html";
}
</script>

<header class="header">
  <div class="container header-inner">
    <div class="brand">Admin<span style="color:var(--orange)">Panel</span></div>
    <div class="hamburger" onclick="toggleNav()">
            <span></span><span></span><span></span>
        </div>
    <nav class="nav">
      <ul class="nav-list">
        <li><a href="dashboard.html">Dashboard</a></li>
        <li><a href="add-product.html">Add Product</a></li>
        <li><a href="products.html" style="color:var(--red);font-weight:700;">Manage Products</a></li>
        <li><a href="customers.html">Customers</a></li>
        <li><a href="order.html">Orders</a></li>
        <li><a href="#" onclick="logoutAdmin()">Logout</a></li>
      </ul>
    </nav>
  </div>
</header>

<div class="container" style="padding:40px 0;">
  <h2 style="color:var(--red);font-weight:800;">Manage Products</h2>
  <div id="productList" style="margin-top:24px;"></div>
</div>

<script src="../assets/js/app.js"></script>

<script>
const API = CONFIG.API;
let PRODUCTS = [];

/* LOAD */
async function loadProducts(){
  const res = await fetch(`${API}/products`);
  const products = await res.json();
  PRODUCTS = products;

  const list = document.getElementById("productList");
  list.innerHTML = "";

  products.forEach(p=>{
    list.innerHTML += `
      <div class="product-card">
        <div class="image-row">
          ${p.images.map(img=>`
            <div class="img-wrap">
              <img src="${img.url}">
              <button onclick="deleteImage(${img.id})">✖</button>
            </div>
          `).join("")}
          <button class="add-img-btn" onclick="addImage(${p.id})">➕</button>
        </div>

        <div style="flex:1;">
          <h3>${p.name}</h3>
          <p>ID: ${p.product_no}</p>
          <p>₹${p.price} • Stock: ${p.stock}</p>
          <p>Category: ${p.category}</p>
        </div>

        <div class="product-actions">
          <button class="btn primary" onclick="openEdit(${p.id})">Edit</button>
          <button class="btn ghost" onclick="deleteProduct(${p.id})">Delete</button>
        </div>
      </div>
    `;
  });
}

/* ADD IMAGE */
function addImage(id){
  cloudinary.openUploadWidget({
    cloudName:"du7hfexwm",
    uploadPreset:"unsigned_chunri_upload"
  },(err,res)=>{
    if(!err && res.event==="success"){
      fetch(`${API}/product/${id}/image`,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({image_url:res.info.secure_url})
      }).then(loadProducts);
    }
  });
}

/* DELETE IMAGE */
function deleteImage(id){
  fetch(`${API}/product/image/${id}`,{method:"DELETE"}).then(loadProducts);
}

/* DELETE PRODUCT */
function deleteProduct(id){
  fetch(`${API}/product/${id}`,{method:"DELETE"}).then(loadProducts);
}

/* EDIT */
function openEdit(id){
  const p = PRODUCTS.find(x=>x.id===id);
  const modal = document.createElement("div");
  modal.className="modal";
  modal.innerHTML=`
    <div class="modal-box">
      <h3>Edit Product</h3>
      <input id="product_no" value="${p.product_no}">
      <input id="e_name" value="${p.name}">
      <input id="e_price" type="number" value="${p.price}">
      <input id="e_stock" type="number" value="${p.stock}">
      <input id="e_category" value="${p.category}">
      <input id="e_description" value="${p.description || ""}">
      <button class="btn primary" style="width:100%" onclick="saveEdit(${id})">Save</button>
      <button class="btn ghost" style="width:100%;margin-top:8px" onclick="this.closest('.modal').remove()">Cancel</button>
    </div>
  `;
  document.body.appendChild(modal);
}

/* SAVE */
function saveEdit(id){
  fetch(`${API}/product/${id}`,{
    method:"PUT",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      name:e_name.value,
      price:Number(e_price.value),
      stock:Number(e_stock.value),
      category:e_category.value,
      description:e_description.value
    })
  }).then(()=>{
    document.querySelector(".modal").remove();
    loadProducts();
  });
}

/* AUTH */
function logoutAdmin(){
  localStorage.clear();
  location.href="admin-login.html";
}

loadProducts();
</script>
<div id="confirmModal" class="modal" style="display:none;">
  <div class="modal-box">
    <h3 id="confirmTitle">Are you sure?</h3>
    <p id="confirmText" style="opacity:.8;margin-bottom:14px;"></p>

    <button id="confirmYes" class="btn primary" style="width:100%;">Yes, Delete</button>
    <button class="btn ghost" style="width:100%;margin-top:8px;"
      onclick="closeConfirm()">Cancel</button>
  </div>
</div>

</body>
</html>
