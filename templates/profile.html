<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - Chunri Store</title>

    <link rel="stylesheet" href="../assets/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: Poppins, sans-serif; 
            background: #f9f9f9; 
        }

        .profile-box {
            max-width: 650px;
            margin: 40px auto;
            background: #fff;
            padding: 30px;
            border-radius: 14px;
            box-shadow: 0 5px 18px rgba(0,0,0,0.08);
        }

        h2 { 
            color: var(--red); 
            text-align: center; 
            font-weight: 700;
            margin-bottom: 25px; 
        }

        label { 
            font-weight: 600; 
            margin-top: 12px; 
            display: block; 
        }

        input {
            width: 100%; 
            padding: 12px;
            margin-top: 6px;
            border: 1px solid #ccc;
            border-radius: 10px;
            font-size: 15px;
        }

        button {
            width: 100%;
            padding: 14px;
            margin-top: 18px;
            background: var(--red);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
        }

        button:hover {
            opacity: 0.9;
        }

        .section-title {
            font-weight: 700;
            margin-top: 35px;
            color: var(--orange);
            border-left: 5px solid var(--red);
            padding-left: 10px;
        }

        .success { color: green; margin-top: 10px; }
        .error { color: red; margin-top: 10px; }

        .password-box { position: relative; width: 100%; }
        .password-box input { padding-right: 45px; }
        
        .password-box .toggle {
            position: absolute;
            right: 12px;
            top: 13px;
            cursor: pointer;
            font-size: 18px;
        }

        /* Mobile Fix */
        @media (max-width: 600px) {
            .profile-box {
                margin: 20px;
                padding: 20px;
            }

            button {
                font-size: 15px;
            }
        }
        input.readonly {
    background: #f2f2f2;
    cursor: not-allowed;
    color: #777;
}
    </style>
</head>

<body>

    <!-- HEADER -->
    <header class="header">
        <div class="container header-inner">
            <div class="brand">
  <span class="brand-icon">üêº</span>
  <span class="brand-text">Panda<span>Store</span></span>
</div>

            <div class="hamburger" onclick="toggleNav()">
                <span></span><span></span><span></span>
            </div>

            <nav class="nav">
                <ul class="nav-list">
                    <li id="productsLink"><a href="/pandastore/index.html
">Products</a></li>
                    <li id="cartLink"><a href="/pandastore/templates/cart.html">Cart</a></li>
                    <li id="ordersLink"><a href="/pandastore/templates/orders.html">Orders</a></li>
                    <li id="profileLink"><a href="/pandastore/templates/profile.html" style="color:var(--red);font-weight:700;">Profile</a></li>
                    <li id="logoutLink" style="display:none;">
                        <a href="/pandastore/templates/login.html" onclick="logoutUser()">Logout</a>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- PROFILE BOX -->
    <div class="profile-box">

        <h2>Your Profile</h2>

        <p id="msg"></p>

        <!-- USER DETAILS -->
        <label>Name</label>
        <input type="text" id="name">

        <label>Email</label>
        <input type="email" id="email" disabled title="Email cannot be changed">

        <label>Phone</label>
        <input type="text" id="phone">

        <label>Address</label>
        <input type="text" id="address">

        <button onclick="updateProfile()">Update Profile</button>


        <!-- PASSWORD SECTION -->
        <h3 class="section-title">Change Password</h3>

        <label>Old Password</label>
        <div class="password-box">
            <input type="password" id="old_password">
            <span class="toggle" onclick="togglePassword('old_password', this)">üëÅÔ∏è</span>
        </div>

        <label>New Password</label>
        <div class="password-box">
            <input type="password" id="new_password">
            <span class="toggle" onclick="togglePassword('new_password', this)">üëÅÔ∏è</span>
        </div>
        <p id="passwordMsg" style="
  margin-top:8px;
  font-size:14px;
  display:none;
"></p>

        <button id="changePwdBtn" onclick="changePassword()" disabled>
  Change Password
</button>

    </div>

<script src="../assets/js/app.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  if (localStorage.getItem("loggedIn") !== "1") {
    window.location.replace("../login.html");
    return;
  }

  updateNavbar(true);
  loadProfile();
});

// ---------------- LOAD PROFILE ----------------
async function loadProfile() {
  try {
    const res = await fetch(`${CONFIG.API}/auth/profile`, {
      headers: {
        "X-USER-ID": localStorage.getItem("user_id")
      }
    });

    if (!res.ok) {
      throw new Error("Unauthorized");
    }

    const data = await res.json();

    document.getElementById("name").value    = data.name || "";
    document.getElementById("email").value   = data.email || "";
    document.getElementById("phone").value   = data.phone || "";
    document.getElementById("address").value = data.address || "";

  } catch (err) {
    console.error(err);
    localStorage.clear();
    window.location.replace("login.html");
  }
}

// ---------------- UPDATE PROFILE ----------------
async function updateProfile() {
  const body = {
    name: name.value,
    phone: phone.value,
    address: address.value
  };

  const res = await fetch(`${CONFIG.API}/auth/profile/update`, {
  method: "PUT",
  headers: {
    "Content-Type": "application/json",
    "X-USER-ID": localStorage.getItem("user_id")
  },
  body: JSON.stringify(body)
});

  const data = await res.json();

  if (!res.ok) {
    showMessage(data.error || "Profile update failed", "error");
    return;
  }

  showMessage("Profile updated successfully!", "success");
}

const passwordMsg = document.getElementById("passwordMsg");
// üîê PASSWORD RULE
const strongPasswordRegex =
/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^A-Za-z0-9]).{8,}$/;

const newPasswordInput = document.getElementById("new_password");

newPasswordInput.addEventListener("input", () => {
  const value = newPasswordInput.value.trim();

  if (!value) {
    passwordMsg.style.display = "none";
    return;
  }

  passwordMsg.style.display = "block";

  if (strongPasswordRegex.test(value)) {
    passwordMsg.style.color = "green";
    passwordMsg.textContent = "Strong password ‚úî";
  } else {
    passwordMsg.style.color = "#d62828";
    passwordMsg.innerHTML = `
      Password must contain:
      <br>‚Ä¢ 8+ characters
      <br>‚Ä¢ 1 uppercase letter
      <br>‚Ä¢ 1 lowercase letter
      <br>‚Ä¢ 1 number
      <br>‚Ä¢ 1 special character
    `;
  }
});
const changePwdBtn = document.getElementById("changePwdBtn");

newPasswordInput.addEventListener("input", () => {
  const value = newPasswordInput.value.trim();

  if (!value) {
    passwordMsg.style.display = "none";
    changePwdBtn.disabled = true;
    return;
  }

  passwordMsg.style.display = "block";

  if (strongPasswordRegex.test(value)) {
    passwordMsg.style.color = "green";
    passwordMsg.textContent = "Strong password ‚úî";
    changePwdBtn.disabled = false;
  } else {
    passwordMsg.style.color = "#d62828";
    passwordMsg.innerHTML = `
      Password must contain:
      <br>‚Ä¢ 8+ characters
      <br>‚Ä¢ 1 uppercase letter
      <br>‚Ä¢ 1 lowercase letter
      <br>‚Ä¢ 1 number
      <br>‚Ä¢ 1 special character
    `;
    changePwdBtn.disabled = true;
  }
});

// ---------------- CHANGE PASSWORD ----------------
async function changePassword() {
  const oldPwd = old_password.value.trim();
  const newPwd = new_password.value.trim();
  const userId = localStorage.getItem("user_id");

  if (!oldPwd || !newPwd) {
    showMessage("Both password fields are required", "error");
    return;
  }

  if (!userId) {
    showMessage("User not logged in", "error");
    return;
  }

  const res = await fetch(`${CONFIG.API}/auth/profile/change-password`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      user_id: userId,
      old_password: oldPwd,
      new_password: newPwd
    })
  });

  const data = await res.json();

  if (!res.ok) {
    showMessage(data.error || "Failed to change password", "error");
    return;
  }

  showMessage("Password updated successfully!", "success");
}

// ---------------- SHOW MESSAGE ----------------
function showMessage(text, type = "info") {
  const msg = document.getElementById("msg");
  if (!msg) return;

  msg.textContent = text;
  msg.className = type;
  msg.style.display = "block";

  clearTimeout(msg._timer);
  msg._timer = setTimeout(() => {
    msg.style.display = "none";
    msg.textContent = "";
  }, 3000);
}

// ---------------- TOGGLE PASSWORD ----------------
function togglePassword(id, icon) {
  const field = document.getElementById(id);
  if (field.type === "password") {
    field.type = "text";
    icon.textContent = "üôà";
  } else {
    field.type = "password";
    icon.textContent = "üëÅÔ∏è";
  }
}

</script>
<div id="toast" class="toast"></div>
</body>
</html>
